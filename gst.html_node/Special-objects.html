<html lang="en">
<head>
<title>Special objects - GNU Smalltalk User's Guide</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="GNU Smalltalk User's Guide">
<meta name="generator" content="makeinfo 4.8">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Features.html#Features" title="Features">
<link rel="prev" href="Security.html#Security" title="Security">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.2 or any later version published by the Free Software
     Foundation; with no Invariant Sections, with no Front-Cover Texts,
     and with no Back-Cover Texts.  A copy of the license is included
     in the section entitled ``GNU Free Documentation License''.
   -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<p>
<a name="Special-objects"></a>
Previous:&nbsp;<a rel="previous" accesskey="p" href="Security.html#Security">Security</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Features.html#Features">Features</a>
<hr>
</div>

<h3 class="section">2.11 Special kinds of objects</h3>

<p>A few methods in Object support the creation of particular objects. 
This include:

     <ul>
<li>finalizable objects

     <li>weak and ephemeron objects (i.e. objects whose contents are considered
specially, during the heap scanning phase of garbage collection).

     <li>read-only objects (like literals found in methods)

     <li>fixed objects (guaranteed not to move across garbage collections)

   </ul>

   <p>They are:

<div class="defun">
&mdash; Method on Object: <b>makeWeak</b><var><a name="index-makeWeak-on-Object-23"></a></var><br>
<blockquote><p>Marks the object so that it is considered weak in subsequent garbage
collection passes.  The garbage collector will consider dead an object
which has references only inside weak objects, and will replace
references to such an &ldquo;almost-dead&rdquo; object with nils, and then
send the <code>mourn</code> message to the object. 
</p></blockquote></div>

<div class="defun">
&mdash; Method on Object: <b>makeEphemeron</b><var><a name="index-makeEphemeron-on-Object-24"></a></var><br>
<blockquote><p>Marks the object so that it is considered specially in subsequent
garbage collection passes.  Ephemeron objects are sent the message
<code>mourn</code> when the first instance variable is not referenced
or is referenced <em>only through another instance variable in the
ephemeron</em>.

        <p>Ephemerons provide a very versatile base on which complex interactions
with the garbage collector can be programmed (for example, finalization
which is described below is implemented with ephemerons). 
</p></blockquote></div>

<div class="defun">
&mdash; Method on Object: <b>addToBeFinalized</b><var><a name="index-addToBeFinalized-on-Object-25"></a></var><br>
<blockquote><p>Marks the object so that, as soon as it becomes unreferenced, its
<code>finalize</code> method is called.  Before <code>finalize</code> is called,
the VM implicitly removes the objects from the list of finalizable
ones.  If necessary, the <code>finalize</code> method can mark again
the object as finalizable, but by default finalization will only occur
once.

        <p>Note that a finalizable object is kept in memory even when it has no
references, because tricky finalizers might &ldquo;resuscitate&rdquo; the object;
automatic marking of the object as not to be finalized has the nice side
effect that the VM can simply delay the releasing of the memory associated
to the object, instead of being forced to waste memory even after
finalization happens.

        <p>An object must be explicitly marked as to be finalized <em>every time
the image is loaded</em>; that is, finalizability is not preserved by an
image save.  This was done because in most cases finalization is used
together with operating system resources that would be stale when the
image is loaded again.  For <code>CObject</code>s, in particular, freeing them
would cause a segmentation violation. 
</p></blockquote></div>

<div class="defun">
&mdash; Method on Object: <b>removeToBeFinalized</b><var><a name="index-removeToBeFinalized-on-Object-26"></a></var><br>
<blockquote><p>Removes the to-be-finalized mark from the object. 
As I noted above, the finalize code for the object does not have to
do this explicitly. 
</p></blockquote></div>

<div class="defun">
&mdash; Method on Object: <b>finalize</b><var><a name="index-finalize-on-Object-27"></a></var><br>
<blockquote><p>This method is called by the VM when there are no more references to
the object (or, of course, if it only has references inside weak objects). 
</p></blockquote></div>

<div class="defun">
&mdash; Method on Object: <b>isReadOnly</b><var><a name="index-isReadOnly-on-Object-28"></a></var><br>
<blockquote><p>This method answers whether the VM will refuse to make changes to the
objects when methods like <code>become:</code>, <code>basicAt:put:</code>,
and possibly <code>at:put:</code> too (depending on the implementation of the
method). 
Note that <span class="sc">gnu</span> Smalltalk won't try to intercept assignments to fixed
instance variables, nor assignments via <code>instVarAt:put:</code>. Many
objects (Characters, <code>nil</code>, <code>true</code>, <code>false</code>, method
literals) are read-only by default. 
</p></blockquote></div>

<div class="defun">
&mdash; Method on Object: <b>makeReadOnly:</b><var> aBoolean<a name="index-makeReadOnly_003a-on-Object-29"></a></var><br>
<blockquote><p>Changes the read-only or read-write status of the receiver to that
indicated by <code>aBoolean</code>. 
</p></blockquote></div>

<div class="defun">
&mdash; Method on Object: <b>basicNewInFixedSpace</b><var><a name="index-basicNewInFixedSpace-on-Object-30"></a></var><br>
<blockquote><p>Same as <code>#basicNew</code>, but the object won't move across garbage
collections. 
</p></blockquote></div>

<div class="defun">
&mdash; Method on Object: <b>basicNewInFixedSpace:</b><var><a name="index-basicNewInFixedSpace_003a-on-Object-31"></a></var><br>
<blockquote><p>Same as <code>#basicNew:</code>, but the object won't move across garbage
collections. 
</p></blockquote></div>

<div class="defun">
&mdash; Method on Object: <b>makeFixed</b><var><a name="index-makeFixed-on-Object-32"></a></var><br>
<blockquote><p>Ensure that the receiver won't move across garbage collections. 
This can be used either if you decide after its creation that an
object must be fixed, or if a class does not support using <code>#new</code>
or <code>#new:</code> to create an object
</p></blockquote></div>

   <p>Note that, although particular applications will indeed have a need for
fixed, read-only or finalizable objects, the <code>#makeWeak</code> primitive
is seldom needed and weak objects are normally used only indirectly,
through the so called <dfn>weak collections</dfn>.  These are easier to use
because they provide additional functionality (for example, <code>WeakArray</code>
is able to determine whether an item has been garbage collected, and
<code>WeakSet</code> implements hash table functionality); they are:

     <ul>
<li><code>WeakArray</code>
<li><code>WeakSet</code>
<li><code>WeakKeyDictionary</code>
<li><code>WeakValueLookupTable</code>
<li><code>WeakIdentitySet</code>
<li><code>WeakKeyIdentityDictionary</code>
<li><code>WeakValueIdentityDictionary</code>
</ul>

   <p>Versions of <span class="sc">gnu</span> Smalltalk preceding 2.1 included a <code>WeakKeyLookupTable</code> class
which has been replaced by <code>WeakKeyDictionary</code>; the usage is completely
identical, but the implementation was changed to use a more efficient
approach based on ephemeron objects.

   </body></html>

