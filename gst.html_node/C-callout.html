<html lang="en">
<head>
<title>C callout - GNU Smalltalk User's Guide</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="GNU Smalltalk User's Guide">
<meta name="generator" content="makeinfo 4.8">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="C-and-Smalltalk.html#C-and-Smalltalk" title="C and Smalltalk">
<link rel="prev" href="External-modules.html#External-modules" title="External modules">
<link rel="next" href="C-data-types.html#C-data-types" title="C data types">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.2 or any later version published by the Free Software
     Foundation; with no Invariant Sections, with no Front-Cover Texts,
     and with no Back-Cover Texts.  A copy of the license is included
     in the section entitled ``GNU Free Documentation License''.
   -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<p>
<a name="C-callout"></a>
Next:&nbsp;<a rel="next" accesskey="n" href="C-data-types.html#C-data-types">C data types</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="External-modules.html#External-modules">External modules</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="C-and-Smalltalk.html#C-and-Smalltalk">C and Smalltalk</a>
<hr>
</div>

<h3 class="section">5.2 Using the C callout mechanism</h3>

<p>To use the C callout mechanism, you first need to inform Smalltalk about
the C functions that you wish to call.  You currently need to do this in
two places: 1) you need to establish the mapping between your C
function's address and the name that you wish to refer to it by, and 2)
define that function along with how the argument objects should be
mapped to C data types to the Smalltalk interpreter.  As an example, let
us use the pre-defined (to <span class="sc">gnu</span> Smalltalk) functions of <code>system</code> and
<code>getenv</code>.

   <p>First, the mapping between these functions and string names for the
functions needs to be established in your module.  If you are writing an
external Smalltalk module (which can look at Smalltalk objects and
manipulate them), see <a href="External-modules.html#External-modules">Linking your libraries to the virtual machine</a>; if you are using function from a dynamically
loaded library, see <a href="Dynamic-loading.html#Dynamic-loading">Dynamic loading</a>.

   <p>Second, we need to define a method that will invoke these C functions
and describe its arguments to the Smalltalk runtime system.  Such a
method is defined with a primitive-like syntax, similar to the
following example (taken from <samp><span class="file">kernel/CFuncs.st</span></samp>)
<pre class="example">     system: aString
         &lt;cCall: 'system' returning: #int args: #(#string)&gt;
     
     getenv: aString
         &lt;cCall: 'getenv' returning: #string args: #(#string)&gt;
</pre>
   <p>These methods were defined on class <code>SystemDictionary</code>, so
that we would invoke it thus:
<pre class="example">        Smalltalk system: 'lpr README' !
</pre>
   <p>However, there is no special significance to which class receives the
method; it could have just as well been Float, but it might look kind of
strange to see:
<pre class="example">        1701.0 system: 'mail help-smalltalk@gnu.org' !
</pre>
   <p>The various keyword arguments are described below.

     <dl>
<dt><code>cCall: 'system'</code><dd>This says that we are defining the C function <code>system</code>.  This name
must be <strong>exactly</strong> the same as the string passed to
<code>defineCFunc</code>.

     <p>The name of the method does not have to match the name of the C function;
we could have just as easily defined the selector to be <code>'rambo:
fooFoo'</code>; it's just good practice to define the method with a similar
name and the argument names to reflect the data types that should be
passed.

     <br><dt><code>returning: #int</code><dd>This defines the C data type that will be returned.  It is converted to
the corresponding Smalltalk data type.  The set of valid return types
is:
          <dl>
<dt><code>char</code><dd>Single C character value

          <br><dt><code>string</code><dd>A C char *, converted to a Smalltalk string

          <br><dt><code>stringOut</code><dd>A C char *, converted to a Smalltalk string and then freed.

          <br><dt><code>symbol</code><dd>A C char *, converted to a Smalltalk symbol

          <br><dt><code>symbolOut</code><dd>A C char *, converted to a Smalltalk symbol and then freed.

          <br><dt><code>int</code><dd>A C int value

          <br><dt><code>uInt</code><dd>A C unsigned int value

          <br><dt><code>long</code><dd>A C long value

          <br><dt><code>uLong</code><dd>A C unsigned long value

          <br><dt><code>double</code><dd>A C double, converted to an instance of FloatD

          <br><dt><code>longDouble</code><dd>A C long double, converted to an instance of FloatQ

          <br><dt><code>void</code><dd>No returned value (<code>self</code> returned from Smalltalk)

          <br><dt><code>wchar</code><dd>Single C wide character (<code>wchar_t</code>) value

          <br><dt><code>wstring</code><dd>Wide C string (<code>wchar_t *</code>), converted to a UnicodeString

          <br><dt><code>wstringOut</code><dd>Wide C string (<code>wchar_t *</code>), converted to a UnicodeString and then freed

          <br><dt><code>cObject</code><dd>An anonymous C pointer; useful to pass back to some C function later

          <br><dt><code>smalltalk</code><dd>An anonymous (to C) Smalltalk object pointer; should have been passed to
C at some point in the past or created by the program by calling other
public <span class="sc">gnu</span> Smalltalk functions (see <a href="Smalltalk-types.html#Smalltalk-types">Smalltalk types</a>).

          <br><dt><var>ctype</var><dd>You can pass an instance of CType or one of its subclasses (see <a href="C-data-types.html#C-data-types">C data types</a>).  In this case the object will be sent <code>#narrow</code>
before being returned: an example of this feature is given in the
experimental Gtk+ bindings. 
</dl>

     <br><dt><code>args: #(string)</code><dd>This is an array of symbols that describes the types of the arguments in
order.  For example, to specify a call to open(2), the arguments might
look something like:
     <pre class="example">             args: #(string int int)
     </pre>
     <p>The following argument types are supported; see above for details.

          <dl>
<dt><code>unknown</code><dd>Smalltalk will make the best conversion that it can guess for this
object; see the mapping table below

          <br><dt><code>boolean</code><dd>passed as <code>char</code>, which is promoted to <code>int</code>

          <br><dt><code>char</code><dd>passed as <code>char</code>, which is promoted to <code>int</code>

          <br><dt><code>wchar</code><dd>passed as <code>wchar_t</code>

          <br><dt><code>string</code><dd>passed as <code>char *</code>

          <br><dt><code>stringOut</code><dd>passed as <code>char *</code>, the contents are expected to be overwritten
with a new C string, and the object that was passed becomes the new
string on return

          <br><dt><code>wstring</code><dd>passed as <code>wchar_t *</code>

          <br><dt><code>wstringOut</code><dd>passed as <code>wchar_t *</code>, the contents are expected to be overwritten
with a new C wide string, and the object that was passed becomes the new
string on return

          <br><dt><code>symbol</code><dd>passed as <code>char *</code>

          <br><dt><code>byteArray</code><dd>passed as <code>char *</code>, even though may contain NUL's

          <br><dt><code>int</code><dd>passed as <code>int</code>

          <br><dt><code>uInt</code><dd>passed as <code>unsigned int</code>

          <br><dt><code>long</code><dd>passed as <code>long</code>

          <br><dt><code>uLong</code><dd>passed as <code>unsigned long</code>

          <br><dt><code>double</code><dd>passed as <code>double</code>

          <br><dt><code>longDouble</code><dd>passed as <code>long double</code>

          <br><dt><code>cObject</code><dd>C object value passed as <code>void *</code>.

          <p>Any class with non-pointer indexed instance variables can be passed as
a <code>#cObject</code>, and GNU Smalltalk will pass the address of the first indexed
instance variable.  This however should never be done for functions that
allocate objects, call back into Smalltalk code or otherwise may cause
a garbage collection: after a GC, pointers passed as <code>#cObject</code> may be
invalidated.  In this case, it is safer to pass every object as
<code>#smalltalk</code>, or to only pass <code>CObject</code>s that were returned
by a C function previously.

          <p>In addition, <code>#cObject</code> can be used for function pointers.  These are
instances of <code>CCallable</code> or one of its subclasses.  See <a href="Smalltalk-callbacks.html#Smalltalk-callbacks">Smalltalk callbacks</a> for more information on how to create function pointers for
Smalltalk blocks.

          <br><dt><code>cObjectPtr</code><dd>Pointer to C object value passed as <code>void **</code>.  The <code>CObject</code>
is modified on output to reflect the value stored into the passed object.

          <br><dt><code>smalltalk</code><dd>Pass the object pointer to C.  The C routine should treat the value as a
pointer to anonymous storage.  This pointer can be returned to Smalltalk
at some later point in time.

          <br><dt><code>variadic</code><dt><code>variadicSmalltalk</code><dd>an Array is expected, each of the elements of the array will be
converted like an <code>unknown</code> parameter if <code>variadic</code> is used,
or passed as a raw object pointer for <code>variadicSmalltalk</code>.

          <br><dt><code>self</code><dt><code>selfSmalltalk</code><dd>Pass the receiver, converting it to C like an <code>unknown</code> parameter
if <code>self</code> is used or passing the raw object pointer for
<code>selfSmalltalk</code>.  Parameters passed this way don't map to the
message's arguments, instead they map to the message's receiver. 
</dl>
     </dl>

   <p>Table of parameter conversions:

   <p><table summary=""><tr align="left"><td valign="top">Declared param type </td><td valign="top">Object type          </td><td valign="top">C parameter type used
<br></td></tr><tr align="left"><td valign="top">boolean             </td><td valign="top">Boolean (True, False)</td><td valign="top">int
<br></td></tr><tr align="left"><td valign="top">byteArray           </td><td valign="top">ByteArray            </td><td valign="top">char *
<br></td></tr><tr align="left"><td valign="top">cObject             </td><td valign="top">CObject              </td><td valign="top">void *
<br></td></tr><tr align="left"><td valign="top">cObject             </td><td valign="top">ByteArray, etc.      </td><td valign="top">void *
<br></td></tr><tr align="left"><td valign="top">cObjectPtr          </td><td valign="top">CObject              </td><td valign="top">void **
<br></td></tr><tr align="left"><td valign="top">char                </td><td valign="top">Boolean (True, False)</td><td valign="top">int
<br></td></tr><tr align="left"><td valign="top">char                </td><td valign="top">Character            </td><td valign="top">int (C promotion rule)
<br></td></tr><tr align="left"><td valign="top">char                </td><td valign="top">Integer              </td><td valign="top">int
<br></td></tr><tr align="left"><td valign="top">double              </td><td valign="top">Float                </td><td valign="top">double (C promotion)
<br></td></tr><tr align="left"><td valign="top">longDouble          </td><td valign="top">Float                </td><td valign="top">long double
<br></td></tr><tr align="left"><td valign="top">int                 </td><td valign="top">Boolean (True, False)</td><td valign="top">int
<br></td></tr><tr align="left"><td valign="top">int                 </td><td valign="top">Integer              </td><td valign="top">int
<br></td></tr><tr align="left"><td valign="top">uInt                </td><td valign="top">Boolean (True, False)</td><td valign="top">unsigned int
<br></td></tr><tr align="left"><td valign="top">uInt                </td><td valign="top">Integer              </td><td valign="top">unsigned int
<br></td></tr><tr align="left"><td valign="top">long                </td><td valign="top">Boolean (True, False)</td><td valign="top">long
<br></td></tr><tr align="left"><td valign="top">long                </td><td valign="top">Integer              </td><td valign="top">long
<br></td></tr><tr align="left"><td valign="top">uLong               </td><td valign="top">Boolean (True, False)</td><td valign="top">unsigned long
<br></td></tr><tr align="left"><td valign="top">uLong               </td><td valign="top">Integer              </td><td valign="top">unsigned long
<br></td></tr><tr align="left"><td valign="top">smalltalk, selfSmalltalk </td><td valign="top">anything             </td><td valign="top">OOP
<br></td></tr><tr align="left"><td valign="top">string              </td><td valign="top">String               </td><td valign="top">char *
<br></td></tr><tr align="left"><td valign="top">string              </td><td valign="top">Symbol               </td><td valign="top">char *
<br></td></tr><tr align="left"><td valign="top">stringOut           </td><td valign="top">String               </td><td valign="top">char *
<br></td></tr><tr align="left"><td valign="top">symbol              </td><td valign="top">Symbol               </td><td valign="top">char *
<br></td></tr><tr align="left"><td valign="top">unknown, self       </td><td valign="top">Boolean (True, False)</td><td valign="top">int
<br></td></tr><tr align="left"><td valign="top">unknown, self       </td><td valign="top">ByteArray            </td><td valign="top">char *
<br></td></tr><tr align="left"><td valign="top">unknown, self       </td><td valign="top">CObject              </td><td valign="top">void *
<br></td></tr><tr align="left"><td valign="top">unknown, self       </td><td valign="top">Character            </td><td valign="top">int
<br></td></tr><tr align="left"><td valign="top">unknown, self       </td><td valign="top">Float                </td><td valign="top">double
<br></td></tr><tr align="left"><td valign="top">unknown, self       </td><td valign="top">Integer              </td><td valign="top">long
<br></td></tr><tr align="left"><td valign="top">unknown, self       </td><td valign="top">String               </td><td valign="top">char *
<br></td></tr><tr align="left"><td valign="top">unknown, self       </td><td valign="top">Symbol               </td><td valign="top">char *
<br></td></tr><tr align="left"><td valign="top">unknown, self       </td><td valign="top">anything else        </td><td valign="top">OOP
<br></td></tr><tr align="left"><td valign="top">variadic            </td><td valign="top">Array                </td><td valign="top">each element is passed according to "unknown"
<br></td></tr><tr align="left"><td valign="top">variadicSmalltalk   </td><td valign="top">Array                </td><td valign="top">each element is passed as an OOP
<br></td></tr><tr align="left"><td valign="top">wchar               </td><td valign="top">Character            </td><td valign="top">wchar_t
<br></td></tr><tr align="left"><td valign="top">wstring             </td><td valign="top">UnicodeString        </td><td valign="top">wchar_t *
<br></td></tr><tr align="left"><td valign="top">wstringOut          </td><td valign="top">UnicodeString        </td><td valign="top">wchar_t *
   <br></td></tr></table>

   <p>When your call-out returns <code>#void</code>, depending on your
application you might consider using <dfn>asynchronous
call-outs</dfn>.  These are call-outs that do not suspend the process
that initiated them, so the process might be scheduled again,
executing the code that follows the call-out, during the execution
of the call-out itself.  This is particularly handy when writing
event loops (the most common place where you call back into Smalltalk)
because then <em>you can handle events that arrive during the
handling of an outer event</em> before the outer event's processing
has ended.  Depending on your application this might be correct or
not, of course.  In the future, asynchronous call-outs might be
started into a separate thread.

   <p>An asynchronous call-out is defined using an alternate primitive-like
syntax, <code>asyncCCall:args:</code>.  Note that the returned value parameter
is missing because an asynchronous call-out always returns <code>nil</code>.

   </body></html>

