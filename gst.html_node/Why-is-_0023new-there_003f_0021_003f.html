<html lang="en">
<head>
<title>Why is #new there?!? - GNU Smalltalk User's Guide</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="GNU Smalltalk User's Guide">
<meta name="generator" content="makeinfo 4.8">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Behind-the-scenes.html#Behind-the-scenes" title="Behind the scenes">
<link rel="prev" href="Two-flavors-of-equality.html#Two-flavors-of-equality" title="Two flavors of equality">
<link rel="next" href="Performance.html#Performance" title="Performance">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.2 or any later version published by the Free Software
     Foundation; with no Invariant Sections, with no Front-Cover Texts,
     and with no Back-Cover Texts.  A copy of the license is included
     in the section entitled ``GNU Free Documentation License''.
   -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<p>
<a name="Why-is-%23new-there%3f!%3f"></a>
<a name="Why-is-_0023new-there_003f_0021_003f"></a>
Next:&nbsp;<a rel="next" accesskey="n" href="Performance.html#Performance">Performance</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="Two-flavors-of-equality.html#Two-flavors-of-equality">Two flavors of equality</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Behind-the-scenes.html#Behind-the-scenes">Behind the scenes</a>
<hr>
</div>

<h4 class="subsection">6.12.3 The truth about metaclasses</h4>

<p>Everybody, sooner or later, looks for the implementation of the
<code>#new</code> method in Object class.  To their surprise, they
don't find it; if they're really smart, they search for implementors
of #new in the image and they find out it is implemented by
<code>Behavior</code>... which turns out to be a subclass of Object!  The
truth starts showing to their eyes about that sentence that everybody
says but few people understand: &ldquo;classes are objects&rdquo;.

   <p>Huh? Classes are objects?!? Let me explain.

   <p>Open up an image; then type the text following the
<code>st&gt;</code> prompt.

<pre class="display">         st&gt; <tt>Set superclass!</tt>
         HashedCollection
     
         st&gt; <tt>HashedCollection superclass!</tt>
         Collection
     
         st&gt; <tt>Collection superclass!</tt>
         Object
     
         st&gt; <tt>Object superclass!</tt>
         nil
</pre>
   <p>Nothing new for now.  Let's try something else:

<pre class="display">         st&gt; <tt>#(1 2 3) class!</tt>
         Array
     
         st&gt; <tt>'123' class!</tt>
         String
     
         st&gt; <tt>Set class!</tt>
         Set class
     
         st&gt; <tt>Set class class!</tt>
         Metaclass
</pre>
   <p>You get it, that strange <code>Set class</code> thing is something
called &ldquo;a meta-class&rdquo;... let's go on:

<pre class="display">         st&gt; <tt>^Set class superclass!</tt>
         Collection class
     
         st&gt; <tt>^Collection class superclass!</tt>
         Object class
</pre>
   <p>You see, there is a sort of `parallel' hierarchy between classes
and metaclasses.  When you create a class, Smalltalk creates a
metaclass; and just like a class describes how methods for its
instances work, a metaclass describes how class methods for that
same class work.

   <p><code>Set</code> is an instance of the metaclass, so when you invoke
the <code>#new</code> class method, you can also say you are invoking
an instance method implemented by <code>Set class</code>.  Simply put,
class methods are a lie: they're simply instance methods that
are understood by instances of metaclasses.

   <p>Now you would expect that <code>Object class superclass</code> answers
<code>nil class</code>, that is <code>UndefinedObject</code>.  Yet you saw that
<code>#new</code> is not implemented there... let's try it:

<pre class="display">         st&gt; <tt>^Object class superclass!</tt>
         Class
</pre>
   <p>Uh?!? Try to read it aloud: the <code>Object class</code> class inherits
from the <code>Class</code> class.  <code>Class</code> is the abstract superclass
of all metaclasses, and provides the logic that allows you to create
classes in the image.  But it is not the termination point:

<pre class="display">         st&gt; <tt>^Class superclass!</tt>
         ClassDescription
     
         st&gt; <tt>^ClassDescription superclass!</tt>
         Behavior
     
         st&gt; <tt>^Behavior superclass!</tt>
         Object
</pre>
   <p>Class is a subclass of other classes.  <code>ClassDescription</code> is
abstract; <code>Behavior</code> is concrete but lacks the methods
and state that allow classes to have named instance variables,
class comments and more.  Its instances are called
<em>light-weight</em> classes because they don't have separate
metaclasses, instead they all share <code>Behavior</code> itself as
their metaclass.

   <p>Evaluating <code>Behavior superclass</code> we have worked our way up to
class Object again:  Object is the superclass of all instances as well
as all metaclasses.  This complicated system is extremely powerful,
and allows you to do very interesting things that you probably did
without thinking about it&mdash;for example, using methods such as
<code>#error:</code> or <code>#shouldNotImplement</code> in class methods.

   <p>Now, one final question and one final step: what are metaclasses
instances of?  The question makes sense: if everything has a class,
should not metaclasses have one?

   <p>Evaluate the following:

<pre class="display">         st&gt; <tt>meta := Set class</tt>
         st&gt; <tt>0 to: 4 do: [ :i |</tt>
         st&gt; <tt>    i timesRepeat: [ Transcript space ]</tt>
         st&gt; <tt>    meta printNl</tt>
         st&gt; <tt>    meta := meta class</tt>
         st&gt; <tt>]</tt>
         Set class
          Metaclass
           Metaclass class
            Metaclass
             Metaclass class
         0
</pre>
   <p>If you send <code>#class</code> repeatedly, it seems that you end up
in a loop made of class <code>Metaclass</code><a rel="footnote" href="#fn-1" name="fnd-1"><sup>1</sup></a> and its
own metaclass, <code>Metaclass class</code>.  It looks like class
Metaclass is <i>an instance of an instance of itself</i>.

   <p>To understand the role of <code>Metaclass</code>, it can be useful
to know that the class creation is implemented there. 
Think about it.

     <ul>
<li><code>Random class</code> implements creation and
initialization of its instances' random number seed;
analogously, <code>Metaclass class</code> implements creation and
initialization of its instances, which are metaclasses.

     <li>And <code>Metaclass</code> implements creation and initialization of
its instances, which are classes (subclasses of <code>Class</code>). 
</ul>

   <p>The circle is closed.  In the end, this mechanism implements a
clean, elegant and (with some contemplation) understandable
facility for self-definition of classes.  In other words, it
is what allows classes to talk about themselves, posing the
foundation for the creation of browsers.

   <div class="footnote">
<hr>
<h4>Footnotes</h4><p class="footnote"><small>[<a name="fn-1" href="#fnd-1">1</a>]</small> Which turns
out to be another subclass of <code>ClassDescription</code>.</p>

   <p><hr></div>

   </body></html>

